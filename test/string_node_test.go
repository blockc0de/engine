package test

import (
	"context"
	"github.com/blockc0de/engine"
	"github.com/blockc0de/engine/loader"
	"github.com/stretchr/testify/assert"
	"go.uber.org/zap"
	"testing"
)

func TestStringNode(t *testing.T) {
	graphJson := `{"project_id":"83315aa0-3733-4b49-8355-ff2785a26e7f","name":"NEW_GRAPH","nodes":[{"id":"ffca7476-9e85-4d3d-9713-6af2b4ccdcd4","type":"*nodes.EntryPointNode","out_node":"977cb76d-a559-4a66-85c1-9ca5cae240e1","can_be_executed":false,"can_execute":true,"friendly_name":"Entry Point","block_type":"entry-point","_x":401,"_y":211,"in_parameters":[],"out_parameters":[]},{"id":"66d9b87c-0696-4d76-abed-b4107c4b0fea","type":"*variable.StringNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"String","block_type":"variable","_x":423,"_y":388,"in_parameters":[],"out_parameters":[{"id":"1f75e73d-f61d-4ee3-9098-dfdada45d201","name":"value","type":"System.String","value":"abc","assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"10f6041a-2b1b-4b6b-9581-51eada2bc542","type":"*text.StringConcatNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"Concat String","block_type":"function","_x":701,"_y":423,"in_parameters":[{"id":"1c2c32dd-e928-46a9-85f3-05e0dca7cc82","name":"stringA","type":"System.String","value":null,"assignment":"1f75e73d-f61d-4ee3-9098-dfdada45d201","assignment_node":"66d9b87c-0696-4d76-abed-b4107c4b0fea","value_is_reference":false},{"id":"3075196c-b1b1-40a0-b9fe-4d7aaeccdeb7","name":"stringB","type":"System.String","value":null,"assignment":"f59e838d-410f-49c2-8c9d-34b80449f4ba","assignment_node":"a9e897bc-f7dc-4268-a2bb-ce08657f03ac","value_is_reference":false},{"id":"68d49100-c227-4a23-a4b0-66f7e702e5ae","name":"delimiter","type":"System.String","value":null,"assignment":"dff2ec42-d8fe-40dd-a3b3-c5583b44ed40","assignment_node":"d13de0fc-5d9f-4b4a-a1ff-b516335dcac8","value_is_reference":false}],"out_parameters":[{"id":"983f8986-bffb-4b35-b98a-987c064d2666","name":"string","type":"System.String","value":null,"assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"a9e897bc-f7dc-4268-a2bb-ce08657f03ac","type":"*variable.StringNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"String","block_type":"variable","_x":432,"_y":523,"in_parameters":[],"out_parameters":[{"id":"f59e838d-410f-49c2-8c9d-34b80449f4ba","name":"value","type":"System.String","value":"def","assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"d13de0fc-5d9f-4b4a-a1ff-b516335dcac8","type":"*variable.StringNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"String","block_type":"variable","_x":435,"_y":637,"in_parameters":[],"out_parameters":[{"id":"dff2ec42-d8fe-40dd-a3b3-c5583b44ed40","name":"value","type":"System.String","value":",","assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"145a64ef-12ca-492a-b449-18717ae8a129","type":"*text.StringReplaceNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"Replace String","block_type":"function","_x":1160,"_y":419,"in_parameters":[{"id":"e5b62998-1b5e-4278-b5c9-b71b5d33e0eb","name":"original","type":"System.String","value":null,"assignment":"983f8986-bffb-4b35-b98a-987c064d2666","assignment_node":"10f6041a-2b1b-4b6b-9581-51eada2bc542","value_is_reference":false},{"id":"13a72aff-6a80-42f2-9da8-d0640caa3603","name":"toReplace","type":"System.String","value":null,"assignment":"8dee1ae0-d540-4267-b588-a8231a539fbd","assignment_node":"4169250c-3624-4473-8567-3dbbd34961ba","value_is_reference":false},{"id":"26b3586f-66e6-45c8-8c7f-a260be293b46","name":"replaceText","type":"System.String","value":null,"assignment":"60b2e3a9-e0bc-4050-9fcb-e875d090c702","assignment_node":"863b1457-9e4d-40e3-ae18-0158d8cad9d2","value_is_reference":false}],"out_parameters":[{"id":"cc0ee337-bb9d-48bc-b60d-47c73289d6b5","name":"string","type":"System.String","value":null,"assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"4169250c-3624-4473-8567-3dbbd34961ba","type":"*variable.StringNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"String","block_type":"variable","_x":896,"_y":514,"in_parameters":[],"out_parameters":[{"id":"8dee1ae0-d540-4267-b588-a8231a539fbd","name":"value","type":"System.String","value":",","assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"863b1457-9e4d-40e3-ae18-0158d8cad9d2","type":"*variable.StringNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"String","block_type":"variable","_x":899,"_y":657,"in_parameters":[],"out_parameters":[{"id":"60b2e3a9-e0bc-4050-9fcb-e875d090c702","name":"value","type":"System.String","value":"-","assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"dc11ed82-47e3-42d2-8e9c-eb3e8253467a","type":"*text.StringToUpperNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"String To Upper","block_type":"function","_x":1482,"_y":423,"in_parameters":[{"id":"e9c7eb45-41fa-4012-986d-0bd08c064a70","name":"input","type":"System.String","value":null,"assignment":"cc0ee337-bb9d-48bc-b60d-47c73289d6b5","assignment_node":"145a64ef-12ca-492a-b449-18717ae8a129","value_is_reference":false}],"out_parameters":[{"id":"f5a38a9c-9e38-47ad-b783-4b02da805bc3","name":"string","type":"System.String","value":null,"assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"2dc7b759-8027-46e6-a786-82b6681b8604","type":"*text.StringConcatNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"Concat String","block_type":"function","_x":1876,"_y":433,"in_parameters":[{"id":"35a38572-0be0-4217-9bc3-2314fa720f42","name":"stringA","type":"System.String","value":null,"assignment":"f5a38a9c-9e38-47ad-b783-4b02da805bc3","assignment_node":"dc11ed82-47e3-42d2-8e9c-eb3e8253467a","value_is_reference":false},{"id":"9af71d42-a115-470d-816b-5f1f4b293594","name":"stringB","type":"System.String","value":null,"assignment":"d1ce698a-c392-472a-85ae-138df8ff48cd","assignment_node":"e5a556be-fa0f-44ba-9af7-13e35c5a415b","value_is_reference":false},{"id":"6f02ec24-c1f6-4cb6-a3e6-db33e0e2af3a","name":"delimiter","type":"System.String","value":null,"assignment":"8d6c2db5-b10e-45e8-b746-63aac0baf8a1","assignment_node":"dd916cd0-a59b-42c7-adfa-d3ec803e0aa9","value_is_reference":false}],"out_parameters":[{"id":"812079aa-8dc8-4c0f-bf07-5c6a8c23a797","name":"string","type":"System.String","value":null,"assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"e5a556be-fa0f-44ba-9af7-13e35c5a415b","type":"*variable.StringNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"String","block_type":"variable","_x":1590,"_y":528,"in_parameters":[],"out_parameters":[{"id":"d1ce698a-c392-472a-85ae-138df8ff48cd","name":"value","type":"System.String","value":"dddddddd","assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"dd916cd0-a59b-42c7-adfa-d3ec803e0aa9","type":"*variable.StringNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"String","block_type":"variable","_x":1596,"_y":663,"in_parameters":[],"out_parameters":[{"id":"8d6c2db5-b10e-45e8-b746-63aac0baf8a1","name":"value","type":"System.String","value":"@","assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"35f1477f-3af2-415f-a40e-b3079f2928d8","type":"*text.StringToLowerNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"String To Lower","block_type":"function","_x":2219,"_y":436,"in_parameters":[{"id":"193e179d-1478-468e-a1f5-9405e6f16c4f","name":"input","type":"System.String","value":null,"assignment":"812079aa-8dc8-4c0f-bf07-5c6a8c23a797","assignment_node":"2dc7b759-8027-46e6-a786-82b6681b8604","value_is_reference":false}],"out_parameters":[{"id":"24354599-21f0-4af3-a71b-d8e2d7126b80","name":"string","type":"System.String","value":null,"assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"26f86a61-ceee-4350-910a-714c478e99a9","type":"*text.StringConcatNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"Concat String","block_type":"function","_x":2752,"_y":424,"in_parameters":[{"id":"93e3e918-0f06-44f1-a3d3-52f73fc76cb0","name":"stringA","type":"System.String","value":null,"assignment":"b3503410-c9e7-45bd-a557-014e4bfad0fe","assignment_node":"141c1f7f-49ad-4190-b9b4-2799d7cbcb24","value_is_reference":false},{"id":"f7509d09-5d2b-4765-9b78-9728d2a2958e","name":"stringB","type":"System.String","value":null,"assignment":"24354599-21f0-4af3-a71b-d8e2d7126b80","assignment_node":"35f1477f-3af2-415f-a40e-b3079f2928d8","value_is_reference":false},{"id":"bd9e2d6a-e6bf-47aa-9da4-2c8fd7dfa9df","name":"delimiter","type":"System.String","value":null,"assignment":"dc865f4a-f17d-44d2-bee6-c25bd4ee7794","assignment_node":"7da51f66-edfa-479a-9773-476566b35600","value_is_reference":false}],"out_parameters":[{"id":"6d13cea9-8ca9-441a-a004-56606572eb6d","name":"string","type":"System.String","value":null,"assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"141c1f7f-49ad-4190-b9b4-2799d7cbcb24","type":"*variable.StringNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"String","block_type":"variable","_x":2486,"_y":315,"in_parameters":[],"out_parameters":[{"id":"b3503410-c9e7-45bd-a557-014e4bfad0fe","name":"value","type":"System.String","value":"rrrrrrrrrrrr","assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"7da51f66-edfa-479a-9773-476566b35600","type":"*variable.StringNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"String","block_type":"variable","_x":2455,"_y":549,"in_parameters":[],"out_parameters":[{"id":"dc865f4a-f17d-44d2-bee6-c25bd4ee7794","name":"value","type":"System.String","value":"#","assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"51ebfa81-8952-4448-a64a-045e7a1c5956","type":"*text.StringTrimLeftNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"Trim Left String","block_type":"function","_x":3127,"_y":424,"in_parameters":[{"id":"14343767-5056-4d38-ac4a-2b8217d48797","name":"input","type":"System.String","value":null,"assignment":"6d13cea9-8ca9-441a-a004-56606572eb6d","assignment_node":"26f86a61-ceee-4350-910a-714c478e99a9","value_is_reference":false},{"id":"e6c40d60-5757-40c1-a37e-01ddaff0c70e","name":"cutset","type":"System.String","value":null,"assignment":"ec1cb4b7-d010-4cda-b09f-b5be3c101c69","assignment_node":"ca9638cf-a5bd-4a0f-8524-8cd49b86642a","value_is_reference":false}],"out_parameters":[{"id":"f792ea90-6ceb-4fac-a358-4763cf436bba","name":"string","type":"System.String","value":null,"assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"ca9638cf-a5bd-4a0f-8524-8cd49b86642a","type":"*variable.StringNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"String","block_type":"variable","_x":2916,"_y":567,"in_parameters":[],"out_parameters":[{"id":"ec1cb4b7-d010-4cda-b09f-b5be3c101c69","name":"value","type":"System.String","value":"r","assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"7b583efa-6dcf-4c45-b835-d1337ca4c844","type":"*text.StringTrimRightNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"Trim Right String","block_type":"function","_x":3469,"_y":426,"in_parameters":[{"id":"d224bfc4-b378-48a2-9494-d81f29ebf2e6","name":"input","type":"System.String","value":null,"assignment":"f792ea90-6ceb-4fac-a358-4763cf436bba","assignment_node":"51ebfa81-8952-4448-a64a-045e7a1c5956","value_is_reference":false},{"id":"11fdc6ec-61c4-43bd-809e-d15a5ccffea7","name":"cutset","type":"System.String","value":null,"assignment":"9376fad1-e7ae-4316-9452-fcfd872a7960","assignment_node":"59c0b85b-4211-48b6-b896-0e8b7fe5be1d","value_is_reference":false}],"out_parameters":[{"id":"959be200-6c1a-4dc6-9407-9fcfd73968f5","name":"string","type":"System.String","value":null,"assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"59c0b85b-4211-48b6-b896-0e8b7fe5be1d","type":"*variable.StringNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"String","block_type":"variable","_x":3268,"_y":552,"in_parameters":[],"out_parameters":[{"id":"9376fad1-e7ae-4316-9452-fcfd872a7960","name":"value","type":"System.String","value":"d","assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"986f91f9-4116-4147-83b7-5b53d7b23ba9","type":"*variable.StringNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"String","block_type":"variable","_x":3631,"_y":567,"in_parameters":[],"out_parameters":[{"id":"868841aa-1eed-4015-8833-0a88397d796e","name":"value","type":"System.String","value":"#abc-def@","assignment":"","assignment_node":"","value_is_reference":false}]},{"id":"564ffbb8-6270-4133-a384-07e0ab255393","type":"*console.PrintNode","out_node":null,"can_be_executed":true,"can_execute":true,"friendly_name":"Print","block_type":"function","_x":4268,"_y":305,"in_parameters":[{"id":"2370abf8-1aec-483a-ac27-4a267339287e","name":"message","type":"System.String","value":null,"assignment":"1db881d8-fa2c-43a9-bb04-47a8140dec2b","assignment_node":"2be6d531-af97-47db-b761-ba5e2cabc5d4","value_is_reference":false}],"out_parameters":[]},{"id":"977cb76d-a559-4a66-85c1-9ca5cae240e1","type":"*text.StringContainsNode","out_node":null,"can_be_executed":true,"can_execute":false,"friendly_name":"String Contains","block_type":"condition","_x":3911,"_y":284,"in_parameters":[{"id":"f974584d-97a4-4d2b-8f63-113a91707a10","name":"string","type":"System.String","value":null,"assignment":"959be200-6c1a-4dc6-9407-9fcfd73968f5","assignment_node":"7b583efa-6dcf-4c45-b835-d1337ca4c844","value_is_reference":false},{"id":"d7715ca7-c7c8-4a08-abd7-01dd0f9d1f73","name":"toSearch","type":"System.String","value":null,"assignment":"868841aa-1eed-4015-8833-0a88397d796e","assignment_node":"986f91f9-4116-4147-83b7-5b53d7b23ba9","value_is_reference":false}],"out_parameters":[{"id":"2c9e4833-f2be-48e5-b646-e4282e2ef8ed","name":"true","type":"NodeBlock.Engine.Node","value":"564ffbb8-6270-4133-a384-07e0ab255393","assignment":"","assignment_node":"","value_is_reference":true},{"id":"57651d7b-5aa8-4afa-9eae-7897d6585ea5","name":"false","type":"NodeBlock.Engine.Node","value":null,"assignment":"","assignment_node":"","value_is_reference":true}]},{"id":"2be6d531-af97-47db-b761-ba5e2cabc5d4","type":"*variable.StringNode","out_node":null,"can_be_executed":false,"can_execute":false,"friendly_name":"String","block_type":"variable","_x":4048,"_y":441,"in_parameters":[],"out_parameters":[{"id":"1db881d8-fa2c-43a9-bb04-47a8140dec2b","name":"value","type":"System.String","value":"true","assignment":"","assignment_node":"","value_is_reference":false}]}],"comments":[]}`

	graph, err := loader.LoadGraph([]byte(graphJson))
	assert.Nil(t, err)

	var result string
	logger, _ := zap.NewProduction()
	engine := engine.NewEngine(graph, logger, func(msgType string, message string) {
		result = message
	})
	engine.Run(context.Background())
	assert.Equal(t, result, "true")
}
